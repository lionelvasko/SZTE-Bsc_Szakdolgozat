@page "/settings"
@using Microsoft.AspNetCore.Authorization

<div class="d-flex flex-column min-vh-100">
    <div class="container my-4">
        <ul class="nav nav-pills justify-content-center ">
            <Microsoft.AspNetCore.Components.Authorization.AuthorizeView>
                <Authorized>
                    <li class="nav-item flex-grow-1 text-center">
                        <a class="nav-link @GetTabClass(1) py-3" @onclick="() => SetActiveTab(1)" style="font-size: 1.25rem; cursor: pointer; transition: all 0.3s; border-radius: 1.5rem;">
                            @Localizer["User settings"]
                        </a>
                    </li>
                    <li class="nav-item flex-grow-1 text-center">
                        <a class="nav-link @GetTabClass(2) py-3" @onclick="() => SetActiveTab(2)" style="font-size: 1.25rem; cursor: pointer; transition: all 0.3s; border-radius: 1.5rem;">
                            @Localizer["Application settings"]
                        </a>
                    </li>
                </Authorized>
                <NotAuthorized>
                    <li class="nav-item flex-grow-1 text-center">
                        <a class="nav-link @GetTabClass(2) py-3" @onclick="() => SetActiveTab(2)" style="font-size: 1.25rem; cursor: pointer; transition: all 0.3s; border-radius: 1.5rem;">
                            @Localizer["Application settings"]
                        </a>
                    </li>
                </NotAuthorized>
            </Microsoft.AspNetCore.Components.Authorization.AuthorizeView>
        </ul>
    </div>

    <!-- Tab content -->
    <div class="flex-grow-1 d-flex align-items-center top-0">
        <div class="container shadow-lg p-5 rounded">
            @if (activeTab == 1)
            {
                <div>
                    <h3 class="text-center text-info mb-4">User Settings</h3>
                    <form>
                        <div class="mb-4">
                            <label for="email" class="form-label fw-bold">@Localizer["Email address"]</label>
                            <input type="email" class="form-control shadow-sm border-secondary" id="email" @bind="userModel.Email" />
                        </div>
                        <div class="mb-4">
                            <label for="name" class="form-label fw-bold">@Localizer["Name"]</label>
                            <input type="text" class="form-control shadow-sm border-secondary" id="name" @bind="userModel.Name" />
                        </div>
                        <div class="mb-4">
                            <label for="password" class="form-label fw-bold">@Localizer["Password"]</label>
                            <input type="password" class="form-control shadow-sm border-secondary" id="password" @bind="password" placeholder="@Localizer["Enter your password"]" />
                        </div>
                        <button type="submit" class="btn btn-info btn-lg shadow w-100" style="border-radius: 2rem;">@Localizer["Save changes"]</button>
                    </form>
                </div>
            }
            else if (activeTab == 2)
            {
                <div>
                    <h3 class="text-center text-info mb-4">@Localizer["Application Settings"]</h3>
                    <form>
                        <div class="mb-4">
                            <label for="theme" class="form-label fw-bold">@Localizer["Theme"]</label>
                            <select class="form-select bg-transparent text-info" @onchange="ChangeTheme" id="theme">
                                <option value="Light" selected="@(ThemeChangingService.CurrentTheme == AppTheme.Light)">@Localizer["Light"]</option>
                                <option value="Dark" selected="@(ThemeChangingService.CurrentTheme == AppTheme.Dark)">@Localizer["Dark"]</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="language" class="form-label fw-bold">@Localizer["Language"]</label>
                            <select class="form-select shadow-sm border-secondary bg-transparent text-info" id="language" @onchange="LanguageChanged">
                                <option value="" disabled selected class="bg-transparent text-info">@Localizer["Select language"]</option>
                                <option value="en">
                                    @Localizer["English"]
                                </option>
                                <option value="hu">
                                    @Localizer["Hungarian"]
                                </option>
                                <option value="de">
                                    @Localizer["German"]
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private int activeTab = 2;
    private string theme = "light";
    private string language;

    private string password = null;

    private Szakdoga.Models.UserModel userModel = new Szakdoga.Models.UserModel();

    protected override async Task OnInitializedAsync()
    {
        language = await SecureStorage.GetAsync("selectedCulture");

        theme = await SecureStorage.GetAsync("selectedTheme") ?? "light";
        ChangeTheme(new ChangeEventArgs { Value = theme });
    }

    private void SetActiveTab(int tabNumber)
    {
        activeTab = tabNumber;
    }

    private string GetTabClass(int tabNumber)
    {
        return activeTab == tabNumber ? "active" : "";
    }


    private async Task LanguageChanged(ChangeEventArgs e)
    {
        string cultureCode = e.Value?.ToString() ?? "en";
        await ChangeLanguage(cultureCode);
    }

    private async Task ChangeLanguage(string cultureCode)
    {
        LocalizationService.SetCulture(cultureCode);
        await SecureStorage.SetAsync("selectedCulture", cultureCode);
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }

    private void ChangeTheme(ChangeEventArgs e)
    {
        var selectedTheme = e.Value?.ToString();
        if (selectedTheme == "Light")
        {
            ThemeChangingService.SetTheme(AppTheme.Light);
        }
        else if (selectedTheme == "Dark")
        {
            ThemeChangingService.SetTheme(AppTheme.Dark);
        }
    }

    [Inject] private IStringLocalizer<AppResources> Localizer { get; set; }
    [Inject] private IJSRuntime JSRuntime { get; set; }
    [Inject] private NavigationManager NavigationManager { get; set; }
    [Inject] private LocalizationService LocalizationService { get; set; }
    [Inject] private ThemeChangingService ThemeChangingService { get; set; }
}
